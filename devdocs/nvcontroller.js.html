<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>nvcontroller.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="NVConnectome.html">NVConnectome</a><ul class='methods'><li data-type='method'><a href="NVConnectome.html#findClosestConnectomeNode">findClosestConnectomeNode</a></li><li data-type='method'><a href="NVConnectome.html#.loadConnectomeFromUrl">loadConnectomeFromUrl</a></li></ul></li><li><a href="NVController.html">NVController</a><ul class='methods'><li data-type='method'><a href="NVController.html#connectToSession">connectToSession</a></li><li data-type='method'><a href="NVController.html#onAzimuthElevationChangeHandler">onAzimuthElevationChangeHandler</a></li><li data-type='method'><a href="NVController.html#onClipPlaneChangeHandler">onClipPlaneChangeHandler</a></li><li data-type='method'><a href="NVController.html#onColormapChangeHandler">onColormapChangeHandler</a></li><li data-type='method'><a href="NVController.html#onCustomMeshShaderAddedHandler">onCustomMeshShaderAddedHandler</a></li><li data-type='method'><a href="NVController.html#onFrameChangeHandler">onFrameChangeHandler</a></li><li data-type='method'><a href="NVController.html#onImageLoadedHandler">onImageLoadedHandler</a></li><li data-type='method'><a href="NVController.html#onMeshAddedFromUrlHandler">onMeshAddedFromUrlHandler</a></li><li data-type='method'><a href="NVController.html#onMeshLoadedHandler">onMeshLoadedHandler</a></li><li data-type='method'><a href="NVController.html#onMeshPropertyChanged">onMeshPropertyChanged</a></li><li data-type='method'><a href="NVController.html#onMeshShaderChanged">onMeshShaderChanged</a></li><li data-type='method'><a href="NVController.html#onOpacityChangeHandler">onOpacityChangeHandler</a></li><li data-type='method'><a href="NVController.html#onVolumeAddedFromUrlHandler">onVolumeAddedFromUrlHandler</a></li><li data-type='method'><a href="NVController.html#onVolumeWithUrlRemovedHandler">onVolumeWithUrlRemovedHandler</a></li><li data-type='method'><a href="NVController.html#onZoom3DChangeHandler">onZoom3DChangeHandler</a></li></ul></li><li><a href="NVDocument.html">NVDocument</a><ul class='methods'><li data-type='method'><a href="NVDocument.html#addImageOptions">addImageOptions</a></li><li data-type='method'><a href="NVDocument.html#download">download</a></li><li data-type='method'><a href="NVDocument.html#getImageOptions">getImageOptions</a></li><li data-type='method'><a href="NVDocument.html#hasImage">hasImage</a></li><li data-type='method'><a href="NVDocument.html#hasImageFromUrl">hasImageFromUrl</a></li><li data-type='method'><a href="NVDocument.html#json">json</a></li><li data-type='method'><a href="NVDocument.html#removeImage">removeImage</a></li><li data-type='method'><a href="NVDocument.html#.deserializeMeshDataObjects">deserializeMeshDataObjects</a></li><li data-type='method'><a href="NVDocument.html#.loadFromJSON">loadFromJSON</a></li></ul></li><li></li><li></li><li><a href="NVImage.html">NVImage</a><ul class='methods'><li data-type='method'><a href="NVImage.html#applyOptionsUpdate">applyOptionsUpdate</a></li><li data-type='method'><a href="NVImage.html#clone">clone</a></li><li data-type='method'><a href="NVImage.html#getImageMetadata">getImageMetadata</a></li><li data-type='method'><a href="NVImage.html#toNiivueObject3D">toNiivueObject3D</a></li><li data-type='method'><a href="NVImage.html#toUint8Array">toUint8Array</a></li><li data-type='method'><a href="NVImage.html#zeroImage">zeroImage</a></li><li data-type='method'><a href="NVImage.html#.zerosLike">zerosLike</a></li></ul></li><li></li><li></li><li></li><li><a href="global.html#NVImageFromUrlOptions">NVImageFromUrlOptions</a></li><li><a href="NVLabel3D_NVLabel3D.html">NVLabel3D</a></li><li><a href="NVLabel3DStyle.html">NVLabel3DStyle</a></li><li><a href="NVMesh.html">NVMesh</a><ul class='methods'><li data-type='method'><a href="NVMesh.html#.loadFromBase64">loadFromBase64</a></li><li data-type='method'><a href="NVMesh.html#.loadFromFile">loadFromFile</a></li><li data-type='method'><a href="NVMesh.html#.loadFromUrl">loadFromUrl</a></li></ul></li><li><a href="global.html#NVMeshFromUrlOptions">NVMeshFromUrlOptions</a></li><li><a href="NVMeshLoaders.html">NVMeshLoaders</a></li><li><a href="NVMeshUtilities.html">NVMeshUtilities</a></li><li><a href="NVMessage.html">NVMessage</a></li><li><a href="NVMessageSet4DVolumeIndexData.html">NVMessageSet4DVolumeIndexData</a></li><li><a href="NVMesssageUpdateData.html">NVMesssageUpdateData</a></li><li><a href="NVUtilities.html">NVUtilities</a></li><li><a href="Niivue.html">Niivue</a><ul class='methods'><li data-type='method'><a href="Niivue.html#addColormap">addColormap</a></li><li data-type='method'><a href="Niivue.html#addLabel">addLabel</a></li><li data-type='method'><a href="Niivue.html#addMesh">addMesh</a></li><li data-type='method'><a href="Niivue.html#addMeshFromUrl">addMeshFromUrl</a></li><li data-type='method'><a href="Niivue.html#addVolume">addVolume</a></li><li data-type='method'><a href="Niivue.html#addVolumeFromUrl">addVolumeFromUrl</a></li><li data-type='method'><a href="Niivue.html#attachTo">attachTo</a></li><li data-type='method'><a href="Niivue.html#attachToCanvas">attachToCanvas</a></li><li data-type='method'><a href="Niivue.html#broadcastTo">broadcastTo</a></li><li data-type='method'><a href="Niivue.html#calculateMinMaxVoxIdx">calculateMinMaxVoxIdx</a></li><li data-type='method'><a href="Niivue.html#cloneVolume">cloneVolume</a></li><li data-type='method'><a href="Niivue.html#closeDrawing">closeDrawing</a></li><li data-type='method'><a href="Niivue.html#colormaps">colormaps</a></li><li data-type='method'><a href="Niivue.html#createCustomMeshShader">createCustomMeshShader</a></li><li data-type='method'><a href="Niivue.html#createEmptyDrawing">createEmptyDrawing</a></li><li data-type='method'><a href="Niivue.html#decodeEmbeddedUMD">decodeEmbeddedUMD</a></li><li data-type='method'><a href="Niivue.html#drawGrowCut">drawGrowCut</a></li><li data-type='method'><a href="Niivue.html#drawMosaic">drawMosaic</a></li><li data-type='method'><a href="Niivue.html#drawOtsu">drawOtsu</a></li><li data-type='method'><a href="Niivue.html#drawUndo">drawUndo</a></li><li data-type='method'><a href="Niivue.html#generateHTML">generateHTML</a></li><li data-type='method'><a href="Niivue.html#generateLoadDocumentJavaScript">generateLoadDocumentJavaScript</a></li><li data-type='method'><a href="Niivue.html#getDescriptives">getDescriptives</a></li><li data-type='method'><a href="Niivue.html#getFrame4D">getFrame4D</a></li><li data-type='method'><a href="Niivue.html#getMediaByUrl">getMediaByUrl</a></li><li data-type='method'><a href="Niivue.html#getOverlayIndexByID">getOverlayIndexByID</a></li><li data-type='method'><a href="Niivue.html#getRadiologicalConvention">getRadiologicalConvention</a></li><li data-type='method'><a href="Niivue.html#getVolumeIndexByID">getVolumeIndexByID</a></li><li data-type='method'><a href="Niivue.html#isMeshExt">isMeshExt</a></li><li data-type='method'><a href="Niivue.html#json">json</a></li><li data-type='method'><a href="Niivue.html#loadConnectome">loadConnectome</a></li><li data-type='method'><a href="Niivue.html#loadConnectomeFromUrl">loadConnectomeFromUrl</a></li><li data-type='method'><a href="Niivue.html#loadDeferred4DVolumes">loadDeferred4DVolumes</a></li><li data-type='method'><a href="Niivue.html#loadDocument">loadDocument</a></li><li data-type='method'><a href="Niivue.html#loadDocumentFromUrl">loadDocumentFromUrl</a></li><li data-type='method'><a href="Niivue.html#loadDrawingFromUrl">loadDrawingFromUrl</a></li><li data-type='method'><a href="Niivue.html#loadFont">loadFont</a></li><li data-type='method'><a href="Niivue.html#loadFreeSurferConnectome">loadFreeSurferConnectome</a></li><li data-type='method'><a href="Niivue.html#loadFreeSurferConnectomeFromUrl">loadFreeSurferConnectomeFromUrl</a></li><li data-type='method'><a href="Niivue.html#loadMatCapTexture">loadMatCapTexture</a></li><li data-type='method'><a href="Niivue.html#loadMeshes">loadMeshes</a></li><li data-type='method'><a href="Niivue.html#loadVolumes">loadVolumes</a></li><li data-type='method'><a href="Niivue.html#meshShaderNames">meshShaderNames</a></li><li data-type='method'><a href="Niivue.html#moveCrosshairInVox">moveCrosshairInVox</a></li><li data-type='method'><a href="Niivue.html#moveVolumeDown">moveVolumeDown</a></li><li data-type='method'><a href="Niivue.html#moveVolumeToBottom">moveVolumeToBottom</a></li><li data-type='method'><a href="Niivue.html#moveVolumeToTop">moveVolumeToTop</a></li><li data-type='method'><a href="Niivue.html#moveVolumeUp">moveVolumeUp</a></li><li data-type='method'><a href="Niivue.html#off">off</a></li><li data-type='method'><a href="Niivue.html#on">on</a></li><li data-type='method'><a href="Niivue.html#onAzimuthElevationChange">onAzimuthElevationChange</a></li><li data-type='method'><a href="Niivue.html#onClipPlaneChange">onClipPlaneChange</a></li><li data-type='method'><a href="Niivue.html#onDebug">onDebug</a></li><li data-type='method'><a href="Niivue.html#onDocumentLoaded">onDocumentLoaded</a></li><li data-type='method'><a href="Niivue.html#onDragRelease">onDragRelease</a></li><li data-type='method'><a href="Niivue.html#onError">onError</a></li><li data-type='method'><a href="Niivue.html#onFrameChange">onFrameChange</a></li><li data-type='method'><a href="Niivue.html#onImageLoaded">onImageLoaded</a></li><li data-type='method'><a href="Niivue.html#onInfo">onInfo</a></li><li data-type='method'><a href="Niivue.html#onIntensityChange">onIntensityChange</a></li><li data-type='method'><a href="Niivue.html#onLocationChange">onLocationChange</a></li><li data-type='method'><a href="Niivue.html#onMeshAddedFromUrl">onMeshAddedFromUrl</a></li><li data-type='method'><a href="Niivue.html#onMeshLoaded">onMeshLoaded</a></li><li data-type='method'><a href="Niivue.html#onMouseUp">onMouseUp</a></li><li data-type='method'><a href="Niivue.html#onVolumeAddedFromUrl">onVolumeAddedFromUrl</a></li><li data-type='method'><a href="Niivue.html#onVolumeUpdated">onVolumeUpdated</a></li><li data-type='method'><a href="Niivue.html#onWarn">onWarn</a></li><li data-type='method'><a href="Niivue.html#refreshDrawing">refreshDrawing</a></li><li data-type='method'><a href="Niivue.html#removeHaze">removeHaze</a></li><li data-type='method'><a href="Niivue.html#removeMesh">removeMesh</a></li><li data-type='method'><a href="Niivue.html#removeMeshByUrl">removeMeshByUrl</a></li><li data-type='method'><a href="Niivue.html#removeVolume">removeVolume</a></li><li data-type='method'><a href="Niivue.html#removeVolumeByIndex">removeVolumeByIndex</a></li><li data-type='method'><a href="Niivue.html#removeVolumeByUrl">removeVolumeByUrl</a></li><li data-type='method'><a href="Niivue.html#reverseFaces">reverseFaces</a></li><li data-type='method'><a href="Niivue.html#saveDocument">saveDocument</a></li><li data-type='method'><a href="Niivue.html#saveHTML">saveHTML</a></li><li data-type='method'><a href="Niivue.html#saveImage">saveImage</a></li><li data-type='method'><a href="Niivue.html#saveScene">saveScene</a></li><li data-type='method'><a href="Niivue.html#setAdditiveBlend">setAdditiveBlend</a></li><li data-type='method'><a href="Niivue.html#setClipPlane">setClipPlane</a></li><li data-type='method'><a href="Niivue.html#setClipPlaneColor">setClipPlaneColor</a></li><li data-type='method'><a href="Niivue.html#setColormap">setColormap</a></li><li data-type='method'><a href="Niivue.html#setColormapNegative">setColormapNegative</a></li><li data-type='method'><a href="Niivue.html#setCornerOrientationText">setCornerOrientationText</a></li><li data-type='method'><a href="Niivue.html#setCrosshairColor">setCrosshairColor</a></li><li data-type='method'><a href="Niivue.html#setCrosshairWidth">setCrosshairWidth</a></li><li data-type='method'><a href="Niivue.html#setCustomMeshShader">setCustomMeshShader</a></li><li data-type='method'><a href="Niivue.html#setDefaults">setDefaults</a></li><li data-type='method'><a href="Niivue.html#setDrawOpacity">setDrawOpacity</a></li><li data-type='method'><a href="Niivue.html#setDrawingEnabled">setDrawingEnabled</a></li><li data-type='method'><a href="Niivue.html#setFrame4D">setFrame4D</a></li><li data-type='method'><a href="Niivue.html#setGamma">setGamma</a></li><li data-type='method'><a href="Niivue.html#setHighResolutionCapable">setHighResolutionCapable</a></li><li data-type='method'><a href="Niivue.html#setInterpolation">setInterpolation</a></li><li data-type='method'><a href="Niivue.html#setMeshLayerProperty">setMeshLayerProperty</a></li><li data-type='method'><a href="Niivue.html#setMeshProperty">setMeshProperty</a></li><li data-type='method'><a href="Niivue.html#setMeshShader">setMeshShader</a></li><li data-type='method'><a href="Niivue.html#setMeshThicknessOn2D">setMeshThicknessOn2D</a></li><li data-type='method'><a href="Niivue.html#setModulationImage">setModulationImage</a></li><li data-type='method'><a href="Niivue.html#setMultiplanarLayout">setMultiplanarLayout</a></li><li data-type='method'><a href="Niivue.html#setMultiplanarPadPixels">setMultiplanarPadPixels</a></li><li data-type='method'><a href="Niivue.html#setOpacity">setOpacity</a></li><li data-type='method'><a href="Niivue.html#setPan2Dxyzmm">setPan2Dxyzmm</a></li><li data-type='method'><a href="Niivue.html#setPenValue">setPenValue</a></li><li data-type='method'><a href="Niivue.html#setRadiologicalConvention">setRadiologicalConvention</a></li><li data-type='method'><a href="Niivue.html#setRenderAzimuthElevation">setRenderAzimuthElevation</a></li><li data-type='method'><a href="Niivue.html#setRenderDrawAmbientOcclusion">setRenderDrawAmbientOcclusion</a></li><li data-type='method'><a href="Niivue.html#setScale">setScale</a></li><li data-type='method'><a href="Niivue.html#setSelectionBoxColor">setSelectionBoxColor</a></li><li data-type='method'><a href="Niivue.html#setSliceMM">setSliceMM</a></li><li data-type='method'><a href="Niivue.html#setSliceMosaicString">setSliceMosaicString</a></li><li data-type='method'><a href="Niivue.html#setSliceType">setSliceType</a></li><li data-type='method'><a href="Niivue.html#setVolume">setVolume</a></li><li data-type='method'><a href="Niivue.html#setVolumeRenderIllumination">setVolumeRenderIllumination</a></li><li data-type='method'><a href="Niivue.html#sph2cartDeg">sph2cartDeg</a></li><li data-type='method'><a href="Niivue.html#syncWith">syncWith</a></li><li data-type='method'><a href="Niivue.html#updateGLVolume">updateGLVolume</a></li></ul></li><li><a href="NiivueObject3D.html">NiivueObject3D</a></li><li><a href="SessionBus.html">SessionBus</a></li><li><a href="SessionUser.html">SessionUser</a></li><li><a href="Shader.html">Shader</a></li></ul><h3>Global</h3><ul><li><a href="global.html#DRAG_MODE">DRAG_MODE</a></li><li><a href="global.html#LabelLineTerminator">LabelLineTerminator</a></li><li><a href="global.html#LabelTextAlignment">LabelTextAlignment</a></li><li><a href="global.html#MESH_EXTENSIONS">MESH_EXTENSIONS</a></li><li><a href="global.html#MULTIPLANAR_TYPE">MULTIPLANAR_TYPE</a></li><li><a href="global.html#MeshType">MeshType</a></li><li><a href="global.html#NVIMAGE_TYPE">NVIMAGE_TYPE</a></li><li><a href="global.html#NVMESSAGE">NVMESSAGE</a></li><li><a href="global.html#SLICE_TYPE">SLICE_TYPE</a></li><li><a href="global.html#getExtents">getExtents</a></li><li><a href="global.html#storageAvailable">storageAvailable</a></li><li><a href="global.html#utiltiesLogger">utiltiesLogger</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">nvcontroller.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { SessionBus, SessionUser } from "./session-bus";
// Disabled warnings because of issue with JSDoc https://github.com/microsoft/TypeScript/issues/14377
// eslint-disable-next-line no-unused-vars
import { NVImage, NVImageFromUrlOptions } from "./nvimage";
// eslint-disable-next-line no-unused-vars
import { NVMesh, NVMeshFromUrlOptions } from "./nvmesh";
// eslint-disable-next-line no-unused-vars
import { Niivue } from "./niivue";

/**
 * Enum for sync operations
 * @readonly
 * @enum {number}
 */
const NVMESSAGE = Object.freeze({
  ZOOM: 1, // "zoom",
  CLIP_PLANE: 2, //"clipPlane",
  AZIMUTH_ELEVATION: 3, // "ae",
  FRAME_CHANGED: 4, // "frame changed",
  VOLUME_ADDED_FROM_URL: 5, // "volume added from url",
  VOLUME_WITH_URL_REMOVED: 6, //"volume with url removed",
  COLORMAP_CHANGED: 7, // "color map has changed",
  OPACITY_CHANGED: 8, //"opacity has changed",
  MESH_FROM_URL_ADDED: 9, //"mesh added from url",
  MESH_WITH_URL_REMOVED: 10, //"mesh with url removed",
  CUSTOM_SHADER_ADDED: 11, // "custom shader added",
  SHADER_CHANGED: 12, //"mesh shader changed",
  MESH_PROPERTY_CHANGED: 13, // "mesh property changed",
});

/**
 * @class NVController
 * @type NVController
 * @description NVController is for synchronizing both remote and local instances of Niivue
 * @constructor
 * @param {Niivue} niivue  Niivue object to conttrol
 */
export class NVController {
  constructor(niivue) {
    this.niivue = niivue;
    this.mediaUrlMap = new Map();
    this.isInSession = false;

    // events for external consumers
    this.onFrameChange = () => {};

    // bind all of our events

    // 2D
    this.niivue.onLocationChange = this.onLocationChangeHandler.bind(this);

    // 3D
    this.niivue.onZoom3DChange = this.onZoom3DChangeHandler.bind(this);
    this.niivue.scene.onAzimuthElevationChange =
      this.onAzimuthElevationChangeHandler.bind(this);
    this.niivue.onClipPlaneChange = this.onClipPlaneChangeHandler.bind(this);

    // volume handlers
    this.niivue.onVolumeAddedFromUrl =
      this.onVolumeAddedFromUrlHandler.bind(this);
    this.niivue.onVolumeWithUrlRemoved =
      this.onVolumeWithUrlRemovedHandler.bind(this);

    // mesh handlers
    this.niivue.onMeshAddedFromUrl = this.onMeshAddedFromUrlHandler.bind(this);
    this.niivue.onMeshWithUrlRemoved =
      this.onMeshWithUrlRemovedHandler.bind(this);
    this.niivue.onCustomMeshShaderAdded =
      this.onCustomMeshShaderAddedHandler.bind(this);
    this.niivue.onMeshShaderChanged = this.onMeshShaderChanged.bind(this);
    this.niivue.onMeshPropertyChanged = this.onMeshPropertyChanged.bind(this);

    // 4D
    this.niivue.onFrameChange = this.onFrameChangeHandler.bind(this);

    // volume specific handlers
    for (const volume of this.niivue.volumes) {
      volume.onColormapChange = this.onColormapChangeHandler.bind(this);
      volume.onOpacityChange = this.onOpacityChangeHandler.bind(this);
    }
  }

  onLocationChangeHandler(location) {
    console.log(location);
  }

  addVolume(volume, url) {
    this.niivue.volumes.push(volume);
    let idx =
      this.niivue.volumes.length === 1 ? 0 : this.niivue.volumes.length - 1;
    this.niivue.setVolume(volume, idx);
    this.niivue.mediaUrlMap.set(volume, url);
  }

  addMesh(mesh, url) {
    this.niivue.meshes.push(mesh);
    let idx =
      this.niivue.meshes.length === 1 ? 0 : this.niivue.meshes.length - 1;
    this.niivue.setMesh(mesh, idx);
    this.niivue.mediaUrlMap.set(mesh, url);
  }

  onNewMessage(msg) {
    switch (msg.op) {
      case NVMESSAGE.ZOOM:
        this.niivue._volScaleMultiplier = msg.zoom;
        break;
      case NVMESSAGE.CLIP_PLANE:
        this.niivue.scene.clipPlane = msg.clipPlane;
        break;
      case NVMESSAGE.AZIMUTH_ELEVATION:
        this.niivue.scene._elevation = msg.elevation;
        this.niivue.scene._azimuth = msg.azimuth;
        break;
      case NVMESSAGE.FRAME_CHANGED:
        {
          let volume = this.niivue.getMediaByUrl(msg.url);
          if (volume) {
            volume.frame4D = msg.index;
          }
        }
        break;
      case NVMESSAGE.VOLUME_ADDED_FROM_URL:
        {
          if (!this.niivue.getMediaByUrl(msg.imageOptions.url)) {
            NVImage.loadFromUrl(msg.imageOptions).then((volume) => {
              this.addVolume(volume, msg.imageOptions.url);
            });
          }
        }
        break;
      case NVMESSAGE.VOLUME_WITH_URL_REMOVED:
        {
          let volume = this.niivue.getMediaByUrl(msg.url);
          if (volume) {
            this.niivue.setVolume(volume, -1);
            this.niivue.mediaUrlMap.delete(volume);
          }
        }
        break;
      case NVMESSAGE.COLORMAP_CHANGED:
        {
          let volume = this.niivue.getMediaByUrl(msg.url);
          volume._colormap = msg.colormap;
          this.niivue.updateGLVolume();
        }
        break;

      case NVMESSAGE.OPACITY_CHANGED:
        {
          let volume = this.niivue.getMediaByUrl(msg.url);
          volume._opacity = msg.opacity;
          this.niivue.updateGLVolume();
        }
        break;
      case NVMESSAGE.MESH_FROM_URL_ADDED:
        if (!this.niivue.getMediaByUrl(msg.meshOptions.url)) {
          msg.meshOptions.gl = this.niivue.gl;
          NVMesh.loadFromUrl(msg.meshOptions).then((mesh) => {
            this.addMesh(mesh, msg.meshOptions.url);
          });
        }
        break;
      case NVMESSAGE.MESH_WITH_URL_REMOVED:
        {
          let mesh = this.niivue.getMediaByUrl(msg.url);
          if (mesh) {
            this.niivue.setMesh(mesh, -1);
            this.niivue.mediaUrlMap.delete(mesh);
          }
        }
        break;
      case NVMESSAGE.CUSTOM_SHADER_ADDED:
        {
          let shader = this.niivue.createCustomMeshShader(
            msg.fragmentShaderText,
            msg.name,
          );
          this.niivue.meshShaders.push(shader);
        }
        break;

      case NVMESSAGE.SHADER_CHANGED:
        this.niivue.meshes[msg.meshIndex].meshShaderIndex = msg.shaderIndex;
        this.niivue.updateGLVolume();
        break;

      case NVMESSAGE.MESH_PROPERTY_CHANGED:
        this.niivue.meshes[msg.meshIndex].setProperty(
          msg.key,
          msg.val,
          this.niivue.gl,
        );
        break;
    }
    this.niivue.drawScene();
  }

  /**
   *
   * @param {string} serverBaseUrl
   * @param {string} sessionName
   * @param {string} sessionKey
   * @param {SessionUser} user
   * @description Connects to existing session or creates new session
   */
  connectToSession(
    sessionName,
    user = undefined,
    serverBaseUrl = undefined,
    sessionKey = undefined,
  ) {
    this.user = user || new SessionUser();
    this.sessionBus = new SessionBus(
      sessionName,
      this.user,
      this.onNewMessage.bind(this),
      serverBaseUrl,
      sessionKey,
    );
    this.isInSession = true;
  }

  /**
   * Zoom level has changed
   * @param {number} zoom
   */
  async onZoom3DChangeHandler(zoom) {
    if (this.isInSession) {
      this.sessionBus.sendSessionMessage({
        op: NVMESSAGE.ZOOM,
        zoom,
      });
    }
  }

  /**
   * Azimuth and/or elevation has changed
   * @param {number} azimuth
   * @param {number} elevation
   */
  async onAzimuthElevationChangeHandler(azimuth, elevation) {
    if (this.isInSession) {
      this.sessionBus.sendSessionMessage({
        op: NVMESSAGE.AZIMUTH_ELEVATION,
        azimuth,
        elevation,
      });
    }
  }

  /**
   * Clip plane has changed
   * @param {number[]} clipPlane
   */
  async onClipPlaneChangeHandler(clipPlane) {
    if (this.isInSession) {
      this.sessionBus.sendSessionMessage({
        op: NVMESSAGE.CLIP_PLANE,
        clipPlane,
      });
    }
  }

  /**
   * Add an image and notify subscribers
   * @param {NVImageFromUrlOptions} imageOptions
   */
  async onVolumeAddedFromUrlHandler(imageOptions, volume) {
    if (this.isInSession) {
      console.log(imageOptions);
      this.sessionBus.sendSessionMessage({
        op: NVMESSAGE.VOLUME_ADDED_FROM_URL,
        imageOptions,
      });
    }
    volume.onColormapChange = this.onColormapChangeHandler.bind(this);
    volume.onOpacityChange = this.onOpacityChangeHandler.bind(this);
  }

  /**
   * A volume has been added
   * @param {NVImage} volume
   */
  async onImageLoadedHandler(volume) {
    volume.onColormapChange = this.onColormapChangeHandler.bind(this);
    volume.onOpacityChange = this.onOpacityChangeHandler.bind(this);
    if (this.isInSession &amp;&amp; this.niivue.mediaUrlMap.has(volume)) {
      let url = this.niivue.mediaUrlMap.get(volume);
      this.sessionBus.sendSessionMessage({
        op: "volume with url added",
        url,
      });
    }
  }

  /**
   * Notifies other users that a volume has been removed
   * @param {string} url
   */
  async onVolumeWithUrlRemovedHandler(url) {
    if (this.isInSession) {
      this.sessionBus.sendSessionMessage({
        op: NVMESSAGE.VOLUME_WITH_URL_REMOVED,
        url,
      });
    }
  }

  /**
   * Notifies that a mesh has been loaded by URL
   * @param {NVMeshFromUrlOptions} meshOptions
   */
  async onMeshAddedFromUrlHandler(meshOptions) {
    console.log("mesh loaded from url");
    console.log(meshOptions);
    if (this.isInSession) {
      this.sessionBus.sendSessionMessage({
        op: NVMESSAGE.MESH_FROM_URL_ADDED,
        meshOptions,
      });
    }
  }

  /**
   * Notifies that a mesh has been added
   * @param {NVMesh} mesh
   */
  async onMeshLoadedHandler(mesh) {
    console.log("mesh has been added");
    console.log(mesh);
  }

  async onMeshWithUrlRemovedHandler(url) {
    if (this.isInSession) {
      this.sessionBus.sendSessionMessage({
        op: NVMESSAGE.MESH_WITH_URL_REMOVED,
        url,
      });
    }
  }

  /**
   *
   * @param {NVImage} volume volume that has changed color maps
   */
  async onColormapChangeHandler(volume) {
    if (this.isInSession &amp;&amp; this.niivue.mediaUrlMap.has(volume)) {
      let url = this.niivue.mediaUrlMap.get(volume);
      let colormap = volume.colormap;
      this.sessionBus.sendSessionMessage({
        op: NVMESSAGE.COLORMAP_CHANGED,
        url,
        colormap,
      });
    }
  }

  /**
   * @param {NVImage} volume volume that has changed opacity
   */
  async onOpacityChangeHandler(volume) {
    if (this.isInSession &amp;&amp; this.niivue.mediaUrlMap.has(volume)) {
      let url = this.niivue.mediaUrlMap.get(volume);
      let opacity = volume.opacity;
      this.sessionBus.sendSessionMessage({
        op: NVMESSAGE.OPACITY_CHANGED,
        url,
        opacity,
      });
    }
  }

  /**
   * Frame for 4D image has changed
   * @param {NVImage} volume
   * @param {number} index
   */
  onFrameChangeHandler(volume, index) {
    console.log("frame has changed to " + index);
    console.log(volume);
    if (this.niivue.mediaUrlMap.has(volume) &amp;&amp; this.isInSession) {
      let url = this.niivue.mediaUrlMap.get(volume);
      this.sessionBus.sendSessionMessage({
        op: NVMESSAGE.FRAME_CHANGED,
        url,
        index,
      });
    }
    this.onFrameChange(volume, index);
  }

  /**
   * Custom mesh shader has been added
   * @param {string} fragmentShaderText shader code to be compiled
   * @param {string} name name of shader, can be used as index
   */
  onCustomMeshShaderAddedHandler(fragmentShaderText, name) {
    if (this.isInSession) {
      this.sessionBus.sendSessionMessage({
        op: NVMESSAGE.CUSTOM_SHADER_ADDED,
        fragmentShaderText,
        name,
      });
    }
  }

  /**
   * Mesh shader has changed
   * @param {number} meshIndex index of mesh
   * @param {number} shaderIndex index of shader
   */
  onMeshShaderChanged(meshIndex, shaderIndex) {
    if (this.isInSession) {
      this.sessionBus.sendSessionMessage({
        op: NVMESSAGE.SHADER_CHANGED,
        meshIndex,
        shaderIndex,
      });
    }
  }

  /**
   * Mesh property has been changed
   * @param {number} meshIndex index of mesh
   * @param {any} key property index
   * @param {any} val property value
   */
  onMeshPropertyChanged(meshIndex, key, val) {
    if (this.isInSession) {
      console.log(NVMESSAGE.MESH_PROPERTY_CHANGED);
      this.sessionBus.sendSessionMessage({
        op: NVMESSAGE.MESH_PROPERTY_CHANGED,
        meshIndex,
        key,
        val,
      });
    }
  }
}
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.2</a> on Fri Nov 17 2023 10:57:36 GMT+0000 (Coordinated Universal Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
