<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>niivue-object3D.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="NVConnectome.html">NVConnectome</a><ul class='methods'><li data-type='method'><a href="NVConnectome.html#findClosestConnectomeNode">findClosestConnectomeNode</a></li><li data-type='method'><a href="NVConnectome.html#.loadConnectomeFromUrl">loadConnectomeFromUrl</a></li></ul></li><li><a href="NVController.html">NVController</a><ul class='methods'><li data-type='method'><a href="NVController.html#connectToSession">connectToSession</a></li><li data-type='method'><a href="NVController.html#onAzimuthElevationChangeHandler">onAzimuthElevationChangeHandler</a></li><li data-type='method'><a href="NVController.html#onClipPlaneChangeHandler">onClipPlaneChangeHandler</a></li><li data-type='method'><a href="NVController.html#onColormapChangeHandler">onColormapChangeHandler</a></li><li data-type='method'><a href="NVController.html#onCustomMeshShaderAddedHandler">onCustomMeshShaderAddedHandler</a></li><li data-type='method'><a href="NVController.html#onFrameChangeHandler">onFrameChangeHandler</a></li><li data-type='method'><a href="NVController.html#onImageLoadedHandler">onImageLoadedHandler</a></li><li data-type='method'><a href="NVController.html#onMeshAddedFromUrlHandler">onMeshAddedFromUrlHandler</a></li><li data-type='method'><a href="NVController.html#onMeshLoadedHandler">onMeshLoadedHandler</a></li><li data-type='method'><a href="NVController.html#onMeshPropertyChanged">onMeshPropertyChanged</a></li><li data-type='method'><a href="NVController.html#onMeshShaderChanged">onMeshShaderChanged</a></li><li data-type='method'><a href="NVController.html#onOpacityChangeHandler">onOpacityChangeHandler</a></li><li data-type='method'><a href="NVController.html#onVolumeAddedFromUrlHandler">onVolumeAddedFromUrlHandler</a></li><li data-type='method'><a href="NVController.html#onVolumeWithUrlRemovedHandler">onVolumeWithUrlRemovedHandler</a></li><li data-type='method'><a href="NVController.html#onZoom3DChangeHandler">onZoom3DChangeHandler</a></li></ul></li><li><a href="NVDocument.html">NVDocument</a><ul class='methods'><li data-type='method'><a href="NVDocument.html#addImageOptions">addImageOptions</a></li><li data-type='method'><a href="NVDocument.html#download">download</a></li><li data-type='method'><a href="NVDocument.html#getImageOptions">getImageOptions</a></li><li data-type='method'><a href="NVDocument.html#hasImage">hasImage</a></li><li data-type='method'><a href="NVDocument.html#hasImageFromUrl">hasImageFromUrl</a></li><li data-type='method'><a href="NVDocument.html#json">json</a></li><li data-type='method'><a href="NVDocument.html#removeImage">removeImage</a></li><li data-type='method'><a href="NVDocument.html#.deserializeMeshDataObjects">deserializeMeshDataObjects</a></li><li data-type='method'><a href="NVDocument.html#.loadFromJSON">loadFromJSON</a></li></ul></li><li></li><li></li><li><a href="NVImage.html">NVImage</a><ul class='methods'><li data-type='method'><a href="NVImage.html#applyOptionsUpdate">applyOptionsUpdate</a></li><li data-type='method'><a href="NVImage.html#clone">clone</a></li><li data-type='method'><a href="NVImage.html#getImageMetadata">getImageMetadata</a></li><li data-type='method'><a href="NVImage.html#toNiivueObject3D">toNiivueObject3D</a></li><li data-type='method'><a href="NVImage.html#toUint8Array">toUint8Array</a></li><li data-type='method'><a href="NVImage.html#zeroImage">zeroImage</a></li><li data-type='method'><a href="NVImage.html#.zerosLike">zerosLike</a></li></ul></li><li></li><li></li><li></li><li><a href="global.html#NVImageFromUrlOptions">NVImageFromUrlOptions</a></li><li><a href="NVLabel3D_NVLabel3D.html">NVLabel3D</a></li><li><a href="NVLabel3DStyle.html">NVLabel3DStyle</a></li><li><a href="NVMesh.html">NVMesh</a><ul class='methods'><li data-type='method'><a href="NVMesh.html#.loadFromBase64">loadFromBase64</a></li><li data-type='method'><a href="NVMesh.html#.loadFromFile">loadFromFile</a></li><li data-type='method'><a href="NVMesh.html#.loadFromUrl">loadFromUrl</a></li></ul></li><li><a href="global.html#NVMeshFromUrlOptions">NVMeshFromUrlOptions</a></li><li><a href="NVMeshLoaders.html">NVMeshLoaders</a></li><li><a href="NVMeshUtilities.html">NVMeshUtilities</a></li><li><a href="NVMessage.html">NVMessage</a></li><li><a href="NVMessageSet4DVolumeIndexData.html">NVMessageSet4DVolumeIndexData</a></li><li><a href="NVMesssageUpdateData.html">NVMesssageUpdateData</a></li><li><a href="NVUtilities.html">NVUtilities</a></li><li><a href="Niivue.html">Niivue</a><ul class='methods'><li data-type='method'><a href="Niivue.html#addColormap">addColormap</a></li><li data-type='method'><a href="Niivue.html#addLabel">addLabel</a></li><li data-type='method'><a href="Niivue.html#addMesh">addMesh</a></li><li data-type='method'><a href="Niivue.html#addMeshFromUrl">addMeshFromUrl</a></li><li data-type='method'><a href="Niivue.html#addVolume">addVolume</a></li><li data-type='method'><a href="Niivue.html#addVolumeFromUrl">addVolumeFromUrl</a></li><li data-type='method'><a href="Niivue.html#attachTo">attachTo</a></li><li data-type='method'><a href="Niivue.html#attachToCanvas">attachToCanvas</a></li><li data-type='method'><a href="Niivue.html#broadcastTo">broadcastTo</a></li><li data-type='method'><a href="Niivue.html#calculateMinMaxVoxIdx">calculateMinMaxVoxIdx</a></li><li data-type='method'><a href="Niivue.html#cloneVolume">cloneVolume</a></li><li data-type='method'><a href="Niivue.html#closeDrawing">closeDrawing</a></li><li data-type='method'><a href="Niivue.html#colormaps">colormaps</a></li><li data-type='method'><a href="Niivue.html#createCustomMeshShader">createCustomMeshShader</a></li><li data-type='method'><a href="Niivue.html#createEmptyDrawing">createEmptyDrawing</a></li><li data-type='method'><a href="Niivue.html#decodeEmbeddedUMD">decodeEmbeddedUMD</a></li><li data-type='method'><a href="Niivue.html#drawGrowCut">drawGrowCut</a></li><li data-type='method'><a href="Niivue.html#drawMosaic">drawMosaic</a></li><li data-type='method'><a href="Niivue.html#drawOtsu">drawOtsu</a></li><li data-type='method'><a href="Niivue.html#drawUndo">drawUndo</a></li><li data-type='method'><a href="Niivue.html#generateHTML">generateHTML</a></li><li data-type='method'><a href="Niivue.html#generateLoadDocumentJavaScript">generateLoadDocumentJavaScript</a></li><li data-type='method'><a href="Niivue.html#getDescriptives">getDescriptives</a></li><li data-type='method'><a href="Niivue.html#getFrame4D">getFrame4D</a></li><li data-type='method'><a href="Niivue.html#getMediaByUrl">getMediaByUrl</a></li><li data-type='method'><a href="Niivue.html#getOverlayIndexByID">getOverlayIndexByID</a></li><li data-type='method'><a href="Niivue.html#getRadiologicalConvention">getRadiologicalConvention</a></li><li data-type='method'><a href="Niivue.html#getVolumeIndexByID">getVolumeIndexByID</a></li><li data-type='method'><a href="Niivue.html#isMeshExt">isMeshExt</a></li><li data-type='method'><a href="Niivue.html#json">json</a></li><li data-type='method'><a href="Niivue.html#loadConnectome">loadConnectome</a></li><li data-type='method'><a href="Niivue.html#loadConnectomeFromUrl">loadConnectomeFromUrl</a></li><li data-type='method'><a href="Niivue.html#loadDeferred4DVolumes">loadDeferred4DVolumes</a></li><li data-type='method'><a href="Niivue.html#loadDocument">loadDocument</a></li><li data-type='method'><a href="Niivue.html#loadDocumentFromUrl">loadDocumentFromUrl</a></li><li data-type='method'><a href="Niivue.html#loadDrawingFromUrl">loadDrawingFromUrl</a></li><li data-type='method'><a href="Niivue.html#loadFont">loadFont</a></li><li data-type='method'><a href="Niivue.html#loadFreeSurferConnectome">loadFreeSurferConnectome</a></li><li data-type='method'><a href="Niivue.html#loadFreeSurferConnectomeFromUrl">loadFreeSurferConnectomeFromUrl</a></li><li data-type='method'><a href="Niivue.html#loadMatCapTexture">loadMatCapTexture</a></li><li data-type='method'><a href="Niivue.html#loadMeshes">loadMeshes</a></li><li data-type='method'><a href="Niivue.html#loadVolumes">loadVolumes</a></li><li data-type='method'><a href="Niivue.html#meshShaderNames">meshShaderNames</a></li><li data-type='method'><a href="Niivue.html#moveCrosshairInVox">moveCrosshairInVox</a></li><li data-type='method'><a href="Niivue.html#moveVolumeDown">moveVolumeDown</a></li><li data-type='method'><a href="Niivue.html#moveVolumeToBottom">moveVolumeToBottom</a></li><li data-type='method'><a href="Niivue.html#moveVolumeToTop">moveVolumeToTop</a></li><li data-type='method'><a href="Niivue.html#moveVolumeUp">moveVolumeUp</a></li><li data-type='method'><a href="Niivue.html#off">off</a></li><li data-type='method'><a href="Niivue.html#on">on</a></li><li data-type='method'><a href="Niivue.html#onAzimuthElevationChange">onAzimuthElevationChange</a></li><li data-type='method'><a href="Niivue.html#onClipPlaneChange">onClipPlaneChange</a></li><li data-type='method'><a href="Niivue.html#onDebug">onDebug</a></li><li data-type='method'><a href="Niivue.html#onDocumentLoaded">onDocumentLoaded</a></li><li data-type='method'><a href="Niivue.html#onDragRelease">onDragRelease</a></li><li data-type='method'><a href="Niivue.html#onError">onError</a></li><li data-type='method'><a href="Niivue.html#onFrameChange">onFrameChange</a></li><li data-type='method'><a href="Niivue.html#onImageLoaded">onImageLoaded</a></li><li data-type='method'><a href="Niivue.html#onInfo">onInfo</a></li><li data-type='method'><a href="Niivue.html#onIntensityChange">onIntensityChange</a></li><li data-type='method'><a href="Niivue.html#onLocationChange">onLocationChange</a></li><li data-type='method'><a href="Niivue.html#onMeshAddedFromUrl">onMeshAddedFromUrl</a></li><li data-type='method'><a href="Niivue.html#onMeshLoaded">onMeshLoaded</a></li><li data-type='method'><a href="Niivue.html#onMouseUp">onMouseUp</a></li><li data-type='method'><a href="Niivue.html#onVolumeAddedFromUrl">onVolumeAddedFromUrl</a></li><li data-type='method'><a href="Niivue.html#onVolumeUpdated">onVolumeUpdated</a></li><li data-type='method'><a href="Niivue.html#onWarn">onWarn</a></li><li data-type='method'><a href="Niivue.html#refreshDrawing">refreshDrawing</a></li><li data-type='method'><a href="Niivue.html#removeHaze">removeHaze</a></li><li data-type='method'><a href="Niivue.html#removeMesh">removeMesh</a></li><li data-type='method'><a href="Niivue.html#removeMeshByUrl">removeMeshByUrl</a></li><li data-type='method'><a href="Niivue.html#removeVolume">removeVolume</a></li><li data-type='method'><a href="Niivue.html#removeVolumeByIndex">removeVolumeByIndex</a></li><li data-type='method'><a href="Niivue.html#removeVolumeByUrl">removeVolumeByUrl</a></li><li data-type='method'><a href="Niivue.html#reverseFaces">reverseFaces</a></li><li data-type='method'><a href="Niivue.html#saveDocument">saveDocument</a></li><li data-type='method'><a href="Niivue.html#saveHTML">saveHTML</a></li><li data-type='method'><a href="Niivue.html#saveImage">saveImage</a></li><li data-type='method'><a href="Niivue.html#saveScene">saveScene</a></li><li data-type='method'><a href="Niivue.html#setAdditiveBlend">setAdditiveBlend</a></li><li data-type='method'><a href="Niivue.html#setClipPlane">setClipPlane</a></li><li data-type='method'><a href="Niivue.html#setClipPlaneColor">setClipPlaneColor</a></li><li data-type='method'><a href="Niivue.html#setColormap">setColormap</a></li><li data-type='method'><a href="Niivue.html#setColormapNegative">setColormapNegative</a></li><li data-type='method'><a href="Niivue.html#setCornerOrientationText">setCornerOrientationText</a></li><li data-type='method'><a href="Niivue.html#setCrosshairColor">setCrosshairColor</a></li><li data-type='method'><a href="Niivue.html#setCrosshairWidth">setCrosshairWidth</a></li><li data-type='method'><a href="Niivue.html#setCustomMeshShader">setCustomMeshShader</a></li><li data-type='method'><a href="Niivue.html#setDefaults">setDefaults</a></li><li data-type='method'><a href="Niivue.html#setDrawOpacity">setDrawOpacity</a></li><li data-type='method'><a href="Niivue.html#setDrawingEnabled">setDrawingEnabled</a></li><li data-type='method'><a href="Niivue.html#setFrame4D">setFrame4D</a></li><li data-type='method'><a href="Niivue.html#setGamma">setGamma</a></li><li data-type='method'><a href="Niivue.html#setHighResolutionCapable">setHighResolutionCapable</a></li><li data-type='method'><a href="Niivue.html#setInterpolation">setInterpolation</a></li><li data-type='method'><a href="Niivue.html#setMeshLayerProperty">setMeshLayerProperty</a></li><li data-type='method'><a href="Niivue.html#setMeshProperty">setMeshProperty</a></li><li data-type='method'><a href="Niivue.html#setMeshShader">setMeshShader</a></li><li data-type='method'><a href="Niivue.html#setMeshThicknessOn2D">setMeshThicknessOn2D</a></li><li data-type='method'><a href="Niivue.html#setModulationImage">setModulationImage</a></li><li data-type='method'><a href="Niivue.html#setMultiplanarLayout">setMultiplanarLayout</a></li><li data-type='method'><a href="Niivue.html#setMultiplanarPadPixels">setMultiplanarPadPixels</a></li><li data-type='method'><a href="Niivue.html#setOpacity">setOpacity</a></li><li data-type='method'><a href="Niivue.html#setPan2Dxyzmm">setPan2Dxyzmm</a></li><li data-type='method'><a href="Niivue.html#setPenValue">setPenValue</a></li><li data-type='method'><a href="Niivue.html#setRadiologicalConvention">setRadiologicalConvention</a></li><li data-type='method'><a href="Niivue.html#setRenderAzimuthElevation">setRenderAzimuthElevation</a></li><li data-type='method'><a href="Niivue.html#setRenderDrawAmbientOcclusion">setRenderDrawAmbientOcclusion</a></li><li data-type='method'><a href="Niivue.html#setScale">setScale</a></li><li data-type='method'><a href="Niivue.html#setSelectionBoxColor">setSelectionBoxColor</a></li><li data-type='method'><a href="Niivue.html#setSliceMM">setSliceMM</a></li><li data-type='method'><a href="Niivue.html#setSliceMosaicString">setSliceMosaicString</a></li><li data-type='method'><a href="Niivue.html#setSliceType">setSliceType</a></li><li data-type='method'><a href="Niivue.html#setVolume">setVolume</a></li><li data-type='method'><a href="Niivue.html#setVolumeRenderIllumination">setVolumeRenderIllumination</a></li><li data-type='method'><a href="Niivue.html#sph2cartDeg">sph2cartDeg</a></li><li data-type='method'><a href="Niivue.html#syncWith">syncWith</a></li><li data-type='method'><a href="Niivue.html#updateGLVolume">updateGLVolume</a></li></ul></li><li><a href="NiivueObject3D.html">NiivueObject3D</a></li><li><a href="SessionBus.html">SessionBus</a></li><li><a href="SessionUser.html">SessionUser</a></li><li><a href="Shader.html">Shader</a></li></ul><h3>Global</h3><ul><li><a href="global.html#DRAG_MODE">DRAG_MODE</a></li><li><a href="global.html#LabelLineTerminator">LabelLineTerminator</a></li><li><a href="global.html#LabelTextAlignment">LabelTextAlignment</a></li><li><a href="global.html#MESH_EXTENSIONS">MESH_EXTENSIONS</a></li><li><a href="global.html#MULTIPLANAR_TYPE">MULTIPLANAR_TYPE</a></li><li><a href="global.html#MeshType">MeshType</a></li><li><a href="global.html#NVIMAGE_TYPE">NVIMAGE_TYPE</a></li><li><a href="global.html#NVMESSAGE">NVMESSAGE</a></li><li><a href="global.html#SLICE_TYPE">SLICE_TYPE</a></li><li><a href="global.html#getExtents">getExtents</a></li><li><a href="global.html#storageAvailable">storageAvailable</a></li><li><a href="global.html#utiltiesLogger">utiltiesLogger</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">niivue-object3D.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { mat4, vec3 } from 'gl-matrix'

/**
 * @class NiivueObject3D
 * @type NiivueObject3D
 * @typedef NiivueObject3D
 * @property {Shader[]} renderShaders
 * @property {boolean} isVisible
 * @property {WebGLVertexArrayObject} vertexBuffer
 * @property {number} indexCount
 * @property {WebGLVertexArrayObject} indexBuffer
 * @property {WebGLVertexArrayObject} textureCoordinateBuffer
 * @property {number} mode
 * @description Object rendered with WebGL
 * @constructor
 * @param {number} id
 * @param {WebGLVertexArrayObject} vertexBuffer
 * @param {number} mode
 * @param {number} indexCount
 * @param {WebGLVertexArrayObject} indexBuffer
 * @param {WebGLVertexArrayObject} textureCoordinateBuffer
 **/
export var NiivueObject3D = function (id, vertexBuffer, mode, indexCount, indexBuffer = null, vao = null) {
  this.BLEND = 1
  this.CULL_FACE = 2
  this.CULL_FRONT = 4
  this.CULL_BACK = 8
  this.ENABLE_DEPTH_TEST = 16
  this.sphereIdx = []
  this.sphereVtx = []
  this.renderShaders = []
  this.isVisible = true
  this.isPickable = true
  this.vertexBuffer = vertexBuffer
  this.indexCount = indexCount
  this.indexBuffer = indexBuffer
  this.vao = vao
  this.mode = mode

  this.glFlags = 0
  this.id = id
  this.colorId = [
    ((id >> 0) &amp; 0xff) / 255.0,
    ((id >> 8) &amp; 0xff) / 255.0,
    ((id >> 16) &amp; 0xff) / 255.0,
    ((id >> 24) &amp; 0xff) / 255.0
  ]

  this.modelMatrix = mat4.create()
  this.scale = [1, 1, 1]
  this.position = [0, 0, 0]
  this.rotation = [0, 0, 0]
  this.rotationRadians = 0.0

  this.extentsMin = []
  this.extentsMax = []
}

NiivueObject3D.generateCrosshairs = function (gl, id, xyzMM, xyzMin, xyzMax, radius, sides = 20) {
  const geometry = this.generateCrosshairsGeometry(gl, xyzMM, xyzMin, xyzMax, radius, sides)
  return new NiivueObject3D(
    id,
    geometry.vertexBuffer,
    gl.TRIANGLES,
    geometry.indexCount,
    geometry.indexBuffer,
    geometry.vao
  )
}

// not included in public docs
NiivueObject3D.generateCrosshairsGeometry = function (gl, xyzMM, xyzMin, xyzMax, radius, sides = 20) {
  const vertices = []
  const indices = []
  let start = vec3.fromValues(xyzMin[0], xyzMM[1], xyzMM[2])
  let dest = vec3.fromValues(xyzMax[0], xyzMM[1], xyzMM[2])
  NiivueObject3D.makeCylinder(vertices, indices, start, dest, radius, sides)
  start = vec3.fromValues(xyzMM[0], xyzMin[1], xyzMM[2])
  dest = vec3.fromValues(xyzMM[0], xyzMax[1], xyzMM[2])
  NiivueObject3D.makeCylinder(vertices, indices, start, dest, radius, sides)
  start = vec3.fromValues(xyzMM[0], xyzMM[1], xyzMin[2])
  dest = vec3.fromValues(xyzMM[0], xyzMM[1], xyzMax[2])
  NiivueObject3D.makeCylinder(vertices, indices, start, dest, radius, sides)
  // console.log('i:',indices.length / 3, 'v:',vertices.length / 3);

  const vertexBuffer = gl.createBuffer()
  gl.bindBuffer(gl.ARRAY_BUFFER, vertexBuffer)
  gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertices), gl.STATIC_DRAW)

  // index buffer allocated in parent class
  const indexBuffer = gl.createBuffer()
  gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, indexBuffer)
  gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, new Uint32Array(indices), gl.STATIC_DRAW)

  const vao = gl.createVertexArray()
  gl.bindVertexArray(vao)
  gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, indexBuffer)
  gl.bindBuffer(gl.ARRAY_BUFFER, vertexBuffer)
  // vertex position: 3 floats X,Y,Z
  gl.enableVertexAttribArray(0)
  gl.vertexAttribPointer(0, 3, gl.FLOAT, false, 0, 0)
  gl.bindVertexArray(null) // https://stackoverflow.com/questions/43904396/are-we-not-allowed-to-bind-gl-array-buffer-and-vertex-attrib-array-to-0-in-webgl

  return {
    vertexBuffer,
    indexBuffer,
    indexCount: indices.length,
    vao
  }
}

NiivueObject3D.getFirstPerpVector = function (v1) {
  const v2 = vec3.fromValues(0.0, 0.0, 0.0)
  if (v1[0] === 0.0) v2[0] = 1.0
  else if (v1[1] === 0.0) v2[1] = 1.0
  else if (v1[2] === 0.0) v2[2] = 1.0
  else {
    // If xyz is all set, we set the z coordinate as first and second argument .
    // As the scalar product must be zero, we add the negated sum of x and y as third argument
    v2[0] = v1[2] // scalp = z*x
    v2[1] = v1[2] // scalp = z*(x+y)
    v2[2] = -(v1[0] + v1[1]) // scalp = z*(x+y)-z*(x+y) = 0
    vec3.normalize(v2, v2)
  }
  return v2
}

NiivueObject3D.subdivide = function (verts, faces) {
  // Subdivide each triangle into four triangles, pushing verts to the unit sphere"""
  let nv = verts.length / 3
  let nf = faces.length / 3
  const n = nf
  const vNew = vec3.create()
  const nNew = vec3.create()
  for (let faceIndex = 0; faceIndex &lt; n; faceIndex++) {
    // setlength(verts, nv + 3);
    const fx = faces[faceIndex * 3 + 0]
    const fy = faces[faceIndex * 3 + 1]
    const fz = faces[faceIndex * 3 + 2]
    const vx = vec3.fromValues(verts[fx * 3 + 0], verts[fx * 3 + 1], verts[fx * 3 + 2])
    const vy = vec3.fromValues(verts[fy * 3 + 0], verts[fy * 3 + 1], verts[fy * 3 + 2])
    const vz = vec3.fromValues(verts[fz * 3 + 0], verts[fz * 3 + 1], verts[fz * 3 + 2])
    vec3.add(vNew, vx, vy)
    vec3.normalize(nNew, vNew)
    verts.push(...nNew)

    vec3.add(vNew, vy, vz)
    vec3.normalize(nNew, vNew)
    verts.push(...nNew)

    vec3.add(vNew, vx, vz)
    vec3.normalize(nNew, vNew)
    verts.push(...nNew)
    // Split the current triangle into four smaller triangles:
    let face = [nv, nv + 1, nv + 2]
    faces.push(...face)
    face = [fx, nv, nv + 2]
    faces.push(...face)
    face = [nv, fy, nv + 1]
    faces.push(...face)
    faces[faceIndex * 3 + 0] = nv + 2
    faces[faceIndex * 3 + 1] = nv + 1
    faces[faceIndex * 3 + 2] = fz
    nf = nf + 3
    nv = nv + 3
  }
}

NiivueObject3D.weldVertices = function (verts, faces) {
  // unify identical vertices
  const nv = verts.length / 3
  // yikes: bubble sort! TO DO: see Surfice for more efficient solution
  let nUnique = 0 // first vertex is unique
  // var remap = new Array();
  const remap = new Int32Array(nv)
  for (let i = 0; i &lt; nv - 1; i++) {
    if (remap[i] !== 0) continue // previously tested
    remap[i] = nUnique
    let v = i * 3
    const x = verts[v]
    const y = verts[v + 1]
    const z = verts[v + 2]
    for (let j = i + 1; j &lt; nv; j++) {
      v += 3
      if (x === verts[v] &amp;&amp; y === verts[v + 1] &amp;&amp; z === verts[v + 2]) remap[j] = nUnique
    }
    nUnique++ // another new vertex
  } // for i
  if (nUnique === nv) return verts
  // console.log('welding vertices removed redundant positions ', nv, '->', nUnique);
  const nf = faces.length
  for (let f = 0; f &lt; nf; f++) faces[f] = remap[faces[f]]
  const vtx = verts.slice(0, nUnique * 3 - 1)
  for (let i = 0; i &lt; nv - 1; i++) {
    const v = i * 3
    const r = remap[i] * 3
    vtx[r] = verts[v]
    vtx[r + 1] = verts[v + 1]
    vtx[r + 2] = verts[v + 2]
  }
  return vtx
}

NiivueObject3D.makeSphere = function (vertices, indices, radius, origin = [0, 0, 0]) {
  let vtx = []
  let idx = []
  if (this.sphereVtx !== undefined) {
    // only generate unit sphere once...
    vtx = this.sphereVtx.slice()
    idx = this.sphereIdx.slice()
  } else {
    vtx = [
      0.0, 0.0, 1.0, 0.894, 0.0, 0.447, 0.276, 0.851, 0.447, -0.724, 0.526, 0.447, -0.724, -0.526, 0.447, 0.276, -0.851,
      0.447, 0.724, 0.526, -0.447, -0.276, 0.851, -0.447, -0.894, 0.0, -0.447, -0.276, -0.851, -0.447, 0.724, -0.526,
      -0.447, 0.0, 0.0, -1.0
    ]
    // let idx = new Uint16Array([
    idx = [
      0, 1, 2, 0, 2, 3, 0, 3, 4, 0, 4, 5, 0, 5, 1, 7, 6, 11, 8, 7, 11, 9, 8, 11, 10, 9, 11, 6, 10, 11, 6, 2, 1, 7, 3, 2,
      8, 4, 3, 9, 5, 4, 10, 1, 5, 6, 7, 2, 7, 8, 3, 8, 9, 4, 9, 10, 5, 10, 6, 1
    ]
    this.subdivide(vtx, idx)
    this.subdivide(vtx, idx)
    vtx = this.weldVertices(vtx, idx)
    this.sphereVtx = vtx.slice()
    this.sphereIdx = idx.slice()
  }
  for (let i = 0; i &lt; vtx.length; i++) vtx[i] = vtx[i] * radius
  const nvtx = vtx.length / 3
  let j = 0
  for (let i = 0; i &lt; nvtx; i++) {
    vtx[j] = vtx[j] + origin[0]
    j++
    vtx[j] = vtx[j] + origin[1]
    j++
    vtx[j] = vtx[j] + origin[2]
    j++
  }
  const idx0 = Math.floor(vertices.length / 3) // first new vertex will be AFTER previous vertices
  for (let i = 0; i &lt; idx.length; i++) idx[i] = idx[i] + idx0

  indices.push(...idx)
  vertices.push(...vtx)
}

NiivueObject3D.makeCylinder = function (vertices, indices, start, dest, radius, sides = 20, endcaps = true) {
  if (sides &lt; 3) sides = 3 // prism is minimal 3D cylinder
  const v1 = vec3.create()
  vec3.subtract(v1, dest, start)
  vec3.normalize(v1, v1) // principle axis of cylinder
  const v2 = NiivueObject3D.getFirstPerpVector(v1) // a unit length vector orthogonal to v1
  // Get the second perp vector by cross product
  const v3 = vec3.create()
  vec3.cross(v3, v1, v2) // a unit length vector orthogonal to v1 and v2
  vec3.normalize(v3, v3)
  let num_v = 2 * sides
  let num_f = 2 * sides
  if (endcaps) {
    num_f += 2 * sides
    num_v += 2
  }
  const idx0 = Math.floor(vertices.length / 3) // first new vertex will be AFTER previous vertices
  const idx = new Uint32Array(num_f * 3)
  const vtx = new Float32Array(num_v * 3)
  function setV(i, vec3) {
    vtx[i * 3 + 0] = vec3[0]
    vtx[i * 3 + 1] = vec3[1]
    vtx[i * 3 + 2] = vec3[2]
  }
  function setI(i, a, b, c) {
    idx[i * 3 + 0] = a + idx0
    idx[i * 3 + 1] = b + idx0
    idx[i * 3 + 2] = c + idx0
  }
  const startPole = 2 * sides
  const destPole = startPole + 1
  if (endcaps) {
    setV(startPole, start)
    setV(destPole, dest)
  }
  const pt1 = vec3.create()
  const pt2 = vec3.create()
  for (let i = 0; i &lt; sides; i++) {
    const c = Math.cos((i / sides) * 2 * Math.PI)
    const s = Math.sin((i / sides) * 2 * Math.PI)
    pt1[0] = radius * (c * v2[0] + s * v3[0])
    pt1[1] = radius * (c * v2[1] + s * v3[1])
    pt1[2] = radius * (c * v2[2] + s * v3[2])
    vec3.add(pt2, start, pt1)
    setV(i, pt2)
    vec3.add(pt2, dest, pt1)
    setV(i + sides, pt2)
    let nxt = 0
    if (i &lt; sides - 1) nxt = i + 1
    setI(i * 2, i, nxt, i + sides)
    setI(i * 2 + 1, nxt, nxt + sides, i + sides)
    if (endcaps) {
      setI(sides * 2 + i, i, startPole, nxt)
      setI(sides * 2 + i + sides, destPole, i + sides, nxt + sides)
    }
  }
  indices.push(...idx)
  vertices.push(...vtx)
}

NiivueObject3D.makeColoredCylinder = function (
  vertices,
  indices,
  colors,
  start,
  dest,
  radius,
  rgba255 = [192, 0, 0, 255],
  sides = 20,
  endcaps = false
) {
  let nv = vertices.length / 3
  this.makeCylinder(vertices, indices, start, dest, radius, sides, endcaps)
  nv = vertices.length / 3 - nv
  const clrs = []
  for (let i = 0; i &lt; nv * 4 - 1; i += 4) {
    clrs[i] = rgba255[0]
    clrs[i + 1] = rgba255[1]
    clrs[i + 2] = rgba255[2]
    clrs[i + 3] = rgba255[3]
  }
  colors.push(...clrs)
}

NiivueObject3D.makeColoredSphere = function (
  vertices,
  indices,
  colors,
  radius,
  origin = [0, 0, 0],
  rgba255 = [0, 0, 192, 255]
) {
  let nv = vertices.length / 3
  this.makeSphere(vertices, indices, radius, origin)
  nv = vertices.length / 3 - nv
  const clrs = []
  for (let i = 0; i &lt; nv * 4 - 1; i += 4) {
    clrs[i] = rgba255[0]
    clrs[i + 1] = rgba255[1]
    clrs[i + 2] = rgba255[2]
    clrs[i + 3] = rgba255[3]
  }
  colors.push(...clrs)
}
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.2</a> on Sun Nov 19 2023 11:38:29 GMT+0000 (Coordinated Universal Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
